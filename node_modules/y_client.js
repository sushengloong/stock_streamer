///////////////////////////////////////////////////////////////////////////////////////////
//
// This module provides quote/chain apis using yahoo finance
//
////////////////////////////////////////////////////////////////////////////////////////////
var http = require('http')
  , libxmljs = require('libxmljs')
  , util = require('util')
 
exports.quote = function(symbol, callback) {
   api('download.finance.yahoo.com', '/d/quotes.csv?s=' + symbol + '&f=nb2b3ra2yj3e7gopjkl1xm3m4h', function(text) {
      cols = text.split(',');
      callback({'symbol':cols[0], 'ask':cols[1], 'bid':cols[2], 'counter':0, 'original_ask':cols[1], 'original_bid':cols[2]});
   });
}  
 
function api(host, path, callback) {
   var options = {
       host: host,
       port: 80,
       path: path,
       method: 'GET',
       headers: {'User-Agent': 'Node'}
   };
   var req = http.request(options, function(res) {
     res.setEncoding('utf8');
     var text = '';
     res.on('data', function (chunk) {
       text += chunk;
     });
     res.on('end', function (e) {
        text = text.replace(/"/g, '');
        callback(text);
     });
     res.on('error', function (e) {
       console.log('Could not send api with response : ' + e.message);
     });
   });
 
   req.on('error', function(e) {
     console.log('Could not send api with response : ' + e.message);
   });
 
   // write data to request body
   req.end();
}
